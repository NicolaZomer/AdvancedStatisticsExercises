---
title: "Exercises Laboratory Session 01"
author: "Nicola Zomer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
---

```{r}
# tidyverse
library(ggplot2)
library(readr)
library(tibble)
library(glue)

# others
library(latex2exp)
library(scales)
library(kableExtra)

```

# Exercise 1 - Vectors and data frames

```{r}
df_lakes <- read.csv("../../data/lochs_of_Scotland.csv", header=TRUE, sep=",")
df_lakes %>%
  kbl() %>%
  kable_styling()
```

```{r}
# Remove columns not containing volume or area and in [mi]
df_lakes <- df_lakes[, c(1, 2, 4)]

# Rename the columns
colnames(df_lakes) <- c('Loch', 'Volume', 'Area')
df_lakes %>%
  kbl() %>%
  kable_styling()

```

## 1. Evaluate the highest and lowest volume and area lake

```{r}
# indices 
idx_max_vol <- which.max(df_lakes$Volume)
idx_min_vol <- which.min(df_lakes$Volume)
idx_max_area <- which.max(df_lakes$Area)
idx_min_area <- which.min(df_lakes$Area)

# results 

cat(
  'Highest volume lake:', df_lakes$Loch[idx_max_vol], ', with volume ', df_lakes$Volume[idx_max_vol], 'km^3\n',
  'Lowest volume lake:', df_lakes$Loch[idx_min_vol], ', with volume ', df_lakes$Volume[idx_min_vol], 'km^3\n', 
  'Highest area lake:', df_lakes$Loch[idx_max_area], ', with area ', df_lakes$Area[idx_max_area], 'km^2\n',
  'Lowest area lake:', df_lakes$Loch[idx_min_area], ', with area ', df_lakes$Area[idx_min_area], 'km^2'
  
  )
```

## 2. Order the frame with respect to the area and determine the two largest area lakes

Ordered dataframe:

```{r}
lakes_byarea <- df_lakes[order(df_lakes$Area, decreasing=TRUE), ]
lakes_byarea %>%
  kbl() %>%
  kable_styling()

```

```{r}
largest_area_2 = lakes_byarea$Loch[1:2]

glue('2 largest area lakes: {largest_area_2[1]} and {largest_area_2[2]}')
```

## 3. By summing up the areas occupied by the lakes, determine the area of Scotland covered by water

```{r}
area_water <- sum(df_lakes$Area)
glue('Area of Scotland covered by water: {area_water} km^2')

```

Reference and data: <https://en.wikipedia.org/wiki/List_of_lochs_of_Scotland>

# Exercise 2 - Crude Oil Production

## 1. Write R code that is able to read the file and import it in a data frame structure

The last column of the data frame contains data on crude oil prices from 1861 to 2020, measured in US dollars per barrel.

```{r}
df_oilprices <- read.csv("../../data/crude-oil-prices.csv", header=TRUE, sep=",")
colnames(df_oilprices) <- c(names(df_oilprices[1:3]), 'Price') 

str(df_oilprices)

```

## 2. Produce a plot with the Oil price as a function of the year

```{r}
gg <- ggplot(df_oilprices, aes(x=Year, y=Price))+
  geom_line(col='navyblue', size=0.8)+
  labs(title="Crude Oil Prices from 1861 to 2020 ($/barrel)", 
       y="Price",
       x='Year', 
       caption = "Source: https://ourworldindata.org/grapher/crude-oil-prices") +
  scale_y_continuous(
    breaks = seq(0, 120, 15),
    minor_breaks = NULL
  ) + 
  scale_x_continuous(
    breaks = seq(1850, 2050, 25),
    minor_breaks = NULL,
    limits=c(1850, 2025)
  )+
  theme_bw()


plot(gg)
```

## 3. Which is the highest price in history ? When did it occur ?

```{r}
highest_price <- max(df_oilprices$Price)
highest_price_year <- df_oilprices$Year[which.max(df_oilprices$Price)]

glue('Highest price in hystory: {format(highest_price, digits=5)} $/barrel.\n
  It occured in {highest_price_year}.')
```

## 4. Plot the derivative of the curve, simply evaluated with the finite difference formula

$$
\frac{\partial price}{\partial year} = price_{j+1}-price{j}
$$

```{r}
prices <- df_oilprices$Price
years <- df_oilprices$Year
derivatives <- prices[2:length(prices)]-prices[1:length(prices)-1]

df_derivatives <- data.frame(years[1:length(years)-1], derivatives)
colnames(df_derivatives) <- c('Year', 'Derivative')

str(df_derivatives)

```

```{r}
gg <- ggplot(df_derivatives, aes(x=Year, y=Derivative))+
  geom_line(col='navyblue', size=0.8) + 
  labs(title="Annual Variation of Crude Oil Prices from 1861 to 2020 ($/barrel)", 
       y=TeX("$\\Delta$Price"),
       x='Year', 
       caption = "Source: https://ourworldindata.org/grapher/crude-oil-prices") +
  scale_x_continuous(
    breaks = seq(1850, 2050, 25),
    minor_breaks = NULL,
    limits=c(1850, 2025)
  ) +
  scale_y_continuous(
    breaks = seq(-45, 45, 15),
    minor_breaks = NULL,
  )+
  theme_bw()

plot(gg)
```

Reference and data: <https://ourworldindata.org/grapher/crude-oil-prices>

# Exercise 3 - World Coal Production

## 1. Write R code that is able to read the file and import it in a tibble structure

```{r}
coal_prod <- read_csv("../../data/coal-production-by-country.csv", col_names=TRUE)
colnames(coal_prod) <- c(names(coal_prod[1:3]), 'Production')

kable(head(coal_prod)) %>%
  kable_styling()
```

```{r}
is_tibble(coal_prod)
```

## 2. Count the number of countries available in the file and produce a barplot with the number of entries for each country

```{r}
countries <- unique(coal_prod$Entity)
cat('Number of countries:', length(countries))

```

```{r, fig.height = 25, fig.width = 7}

gg <- ggplot(data=coal_prod, aes(x=Entity)) +
  geom_bar(stat = "count", width=0.7, fill="steelblue") + 
  coord_flip() +
  scale_x_discrete(limits=rev) +
  labs(title="Number of entries for each country", 
       x="Country",
       y="Count", 
       caption = "Source: https://ourworldindata.org/grapher/coal-production-by-country") +
  theme_bw()

gg


```

For the following items select only the years $$\geq$$ 1970.

## 3. Selecting only the year after 1970, determine the total integrated production for each country and print the top 5 countries with highest coal productions

```{r}
# select only the years after 1970
coal_prod_1970 <- coal_prod[coal_prod['Year']>1970, ]

# total integrated production for each country
int_prod_1970 <- aggregate(coal_prod_1970$Production, by=list(coal_prod_1970$Entity), FUN=sum)
colnames(int_prod_1970) <- c('Country', 'IntProd')

# top 5 countries
int_prod_1970[order(int_prod_1970$IntProd, decreasing = TRUE)[1:5], ] %>%
  kbl() %>%
  kable_styling()

```

As some elements are not countries, I want to remove these rows, and repeat the process until I get 5 countries.

```{r}
removed_elements = c('World', 'Asia Pacific', 'Asia and Oceania', 'OECD',
                     'North America', 'Eurasia', 'Europe', 'EU-28', 'CIS', 'Africa',
                     'South Africa'
                     ) # not all non-countries entries

int_prod_1970 <- int_prod_1970[!int_prod_1970$Country %in% removed_elements, ]

# top 5 countries
int_prod_1970[order(int_prod_1970$IntProd, decreasing = TRUE)[1:5], ] %>%
  kbl() %>%
  kable_styling()

top5_countries <- int_prod_1970$Country[order(int_prod_1970$IntProd, decreasing = TRUE)[1:5]]


```

## 4. For the 5 top Countries, create a plot of production as a function of time

```{r}

# create the reduced dataframe
df_top5 <- coal_prod_1970[coal_prod_1970$Entity %in% top5_countries, ]

# inspect the structure of the dataframe
str(df_top5)
```

```{r}
colors <- c('darkred', 'deepskyblue', 'darkgreen', 'darkgoldenrod', 'darkblue')

ggplot(df_top5, aes(x = Year, y = Production)) + 
  geom_line(aes(color = Entity), size=0.6) + 
  scale_color_manual(values = colors)+ 
  labs(title="Production vs time for the top 5 countries", 
       y="Coal Production (TWh)",
       caption = "Source: https://ourworldindata.org/grapher/coal-production-by-country") +
  theme_bw()

```

## 5. Generate a plot with the cumulative sum of the World's coal production over the years

```{r}
world_cum <- cumsum(coal_prod_1970$Production[coal_prod_1970$Entity=='World'])
years <- coal_prod_1970$Year[coal_prod_1970$Entity=='World']

ggplot() + 
  geom_line(aes(x=years, y=world_cum), col='navyblue', size=1) + 
  labs(title="Cumulative World's coal production", 
       x="Year",
       y="Production", 
       caption = "Source: https://ourworldindata.org/grapher/coal-production-by-country") +
  theme_bw()
  
  

```

Reference and data: <https://ourworldindata.org/grapher/coal-production-by-country>

# Exercise 4 - Covid19 Vaccine data

## File 'vaccinations-by-manufacturer.csv'

### 1. Filter() the original tibble by selecting the following countries: Italy

```{r}

# load the data
urlfile = "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations-by-manufacturer.csv"
vacc_bymanu <- read_csv(url(urlfile), col_names=TRUE)

glimpse(vacc_bymanu)
```

```{r}

# select only data related to Italy
vacc_Italy <- vacc_bymanu[vacc_bymanu$location=='Italy',]
head(vacc_Italy) %>%
  kbl() %>%
  kable_styling()

```

### 2. Plot the number of vaccines given as a function of time for the different vaccine manufacturer

```{r}

# inspect the manufacturers
unique(vacc_Italy$vaccine)
```

```{r}

colors <- c('darkred', 'deepskyblue', 'darkgreen', 'darkgoldenrod', 'darkblue')

gg <- ggplot(vacc_Italy, aes(x = date, y = total_vaccinations)) + 
  geom_line(aes(color = vaccine), size=0.6) + 
  scale_color_manual(values = colors)+ 
  labs(title="Number of vaccines for different manufacturers in Italy", 
       x='Time',
       y='Number of vaccinations',
       color='Vaccine', 
       caption = "Source: https://github.com/owid/covid-19-data/tree/master/public/data") +
  scale_y_continuous(trans='log10') +
  scale_x_date(
    breaks = seq(as.Date("2021-01-01"), as.Date("2022-04-01"), by = "quarter"),
    date_labels="%b-%y")+
  theme_bw()
  
plot(gg)
```

### 3. From the same tibble plot the total number of vaccines shot per day in Italy

```{r}

tot_vacc_Italy <- aggregate(vacc_Italy$total_vaccinations, by=list(vacc_Italy$date), FUN=sum)
colnames(tot_vacc_Italy) <- c('date', 'tot_vaccinations')


gg <- ggplot(tot_vacc_Italy, aes(x = date, y = tot_vaccinations)) + 
  geom_line(col='navyblue', size=1) + 
  labs(title="Number of vaccines per day in Italy", 
       x='Time',
       y='Number of vaccinations',
       caption = "Source: https://github.com/owid/covid-19-data/tree/master/public/data") +
  scale_x_continuous(
    breaks = seq(as.Date("2021-01-01"), as.Date("2022-04-01"), by = "quarter"),
  ) +
  theme_bw()
  
plot(gg)

```

Due to the the missing information about AstraZeneca after Jan 22, the cumulative number of vaccines decreases at a certain point and does strange oscillations.

This implies that if we try to get the number of vaccines per day by taking the difference between consecutive days, we get negative results, that is absurd. Let's fix this.

TODO....

(also I want then to define a function for plotting, and fix the cumulative in the next plots)

```{r}
tot_vacc_Italy_perday <- diff(tot_vacc_Italy$tot_vaccinations)
dates <- tot_vacc_Italy$date[2:length(tot_vacc_Italy$date)]

tot_vacc_Italy_perday <- data.frame(dates, tot_vacc_Italy_perday)
colnames(tot_vacc_Italy_perday) <- c('date', 'tot_vaccinations')

```

### 4. Do the same exercise for the following countries: Germany and United States of America

Germany

```{r}

# select only data related to Germany
vacc_Germany <- vacc_bymanu[vacc_bymanu$location=='Germany',]



# number of vaccines for the different manufacturers
colors <- c('darkred', 'deepskyblue', 'darkgreen', 'darkgoldenrod', 'darkblue')

gg1 <- ggplot(vacc_Germany, aes(x = date, y = total_vaccinations)) + 
  geom_line(aes(color = vaccine), size=0.6) + 
  scale_color_manual(values = colors)+ 
  labs(title="Number of vaccines for different manufacturers in Germany", 
       x='Time',
       y='Number of vaccinations',
       color='Vaccine', 
       caption = "Source: https://github.com/owid/covid-19-data/tree/master/public/data") +
  scale_x_continuous(
    breaks = seq(as.Date("2021-01-01"), as.Date("2022-04-01"), by = "quarter"),
  ) +
  theme_bw()



# total number of vaccines per day in Germany
tot_vacc_Germany <- aggregate(vacc_Germany$total_vaccinations, by=list(vacc_Germany$date), FUN=sum)
colnames(tot_vacc_Germany) <- c('date', 'tot_vaccinations')

gg2 <- ggplot(tot_vacc_Germany, aes(x = date, y = tot_vaccinations)) + 
  geom_line(col='navyblue', size=1) + 
  labs(title="Number of vaccines per day in Germany", 
       x='Time',
       y='Number of vaccinations',
       caption = "Source: https://github.com/owid/covid-19-data/tree/master/public/data") +
  scale_x_continuous(
    breaks = seq(as.Date("2021-01-01"), as.Date("2022-04-01"), by = "quarter"),
  ) +
  theme_bw()



# plot the results
plot(gg1)
plot(gg2)
```

United States of America

```{r}

# select only data related to Germany
vacc_USA <- vacc_bymanu[vacc_bymanu$location=='United States',]



# number of vaccines for the different manufacturers
colors <- c('darkred', 'deepskyblue', 'darkgreen', 'darkgoldenrod', 'darkblue')

gg1 <- ggplot(vacc_USA, aes(x = date, y = total_vaccinations)) + 
  geom_line(aes(color = vaccine), size=0.6) + 
  scale_color_manual(values = colors)+ 
  labs(title="Number of vaccines for different manufacturers in USA", 
       x='Time',
       y='Number of vaccinations',
       color='Vaccine', 
       caption = "Source: https://github.com/owid/covid-19-data/tree/master/public/data") +
  scale_x_continuous(
    breaks = seq(as.Date("2021-01-01"), as.Date("2022-04-01"), by = "quarter"),
  ) +
  theme_bw()



# total number of vaccines per day in USA
tot_vacc_USA <- aggregate(vacc_USA$total_vaccinations, by=list(vacc_USA$date), FUN=sum)
colnames(tot_vacc_USA) <- c('date', 'tot_vaccinations')

gg2 <- ggplot(tot_vacc_USA, aes(x = date, y = tot_vaccinations)) + 
  geom_line(col='navyblue', size=1) + 
  labs(title="Number of vaccines per day in USA", 
       x='Time',
       y='Number of vaccinations',
       caption = "Source: https://github.com/owid/covid-19-data/tree/master/public/data") +
  scale_x_continuous(
    breaks = seq(as.Date("2021-01-01"), as.Date("2022-04-01"), by = "quarter"),
  ) +
  theme_bw()



# plot the results
plot(gg1)
plot(gg2)

```

Data: <https://github.com/owid/covid-19-data/blob/master/public/data/vaccinations/vaccinations-by-manufacturer.csv>

## File 'vaccinations.csv'

### 1. Selecting all the European countries in the tibble, plot the number of daily vaccinations per million as a function of date

```{r}

# load the data
urlfile = "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations.csv"
df_vacc <- read_csv(url(urlfile), col_names=TRUE)

glimpse(df_vacc)
```

```{r}

```

### 2. Study the data structure and produce few relevant plots of your taste

```{r}

```

Data: <https://github.com/owid/covid-19-data/blob/master/public/data/vaccinations/vaccinations.csv>

## 
